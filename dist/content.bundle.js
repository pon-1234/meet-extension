(()=>{let e=null,n=null,t={},o=location.href;const i={danger:{icon:chrome.runtime.getURL("icons/danger.png"),label:"撤退"},onMyWay:{icon:chrome.runtime.getURL("icons/onMyWay.png"),label:"話します"},question:{icon:chrome.runtime.getURL("icons/question.png"),label:"疑問"},assist:{icon:chrome.runtime.getURL("icons/assist.png"),label:"助けて"}},c={danger:{angle:-90,distance:70},onMyWay:{angle:0,distance:70},question:{angle:90,distance:70},assist:{angle:180,distance:70}};function s(){console.log("Content script: Initializing for URL:",o),chrome.runtime.sendMessage({action:"getAuthStatus"}).then(d).catch((e=>{h(e,"background","getAuthStatus"),d(null)})),a(o)}function d(n){const t=n?.user,i=e;e=t;const c=!!document.getElementById("ping-container");JSON.stringify(i)===JSON.stringify(e)&&c||a(o)}function a(t){const o=function(e){if(!e)return null;const n=e.match(/meet\.google\.com\/([a-z0-9\-]+)/i);return n?n[1]:null}(t);if(o!==n&&(n&&chrome.runtime.sendMessage({action:"stopListening",meetingId:n}).catch((e=>h(e,"background","stopListening"))),r(),n=o,n&&e&&chrome.runtime.sendMessage({action:"startListening",meetingId:n}).catch((e=>h(e,"background","startListening")))),n&&e){e&&n&&(document.getElementById("ping-container")||function(){if(document.getElementById("ping-container"))return;const e=document.createElement("div");e.id="ping-container";const t=document.createElement("button");t.id="ping-menu-button",t.innerHTML="<span>!</span>",t.title="ピンメニューを開く",t.addEventListener("click",m),e.appendChild(t);const o=document.createElement("div");o.id="ping-menu",o.classList.add("hidden");const s=document.createElement("div");s.id="ping-center";const d=document.createElement("img");d.src=chrome.runtime.getURL("icons/center-pin.png"),d.alt="PING",d.width=32,d.height=32,s.appendChild(d),o.appendChild(s),Object.keys(i).forEach((e=>{const t=i[e],s=c[e],d=document.createElement("div");d.className="ping-option",d.dataset.type=e,d.title=t.label;const a=document.createElement("div");a.className="ping-icon";const r=document.createElement("img");if(r.src=t.icon,r.alt=t.label,r.width=24,r.height=24,a.appendChild(r),d.appendChild(a),s){const e=s.angle*(Math.PI/180),n=Math.cos(e)*s.distance,t=Math.sin(e)*s.distance;d.style.position="absolute",d.style.top="50%",d.style.left="50%",d.style.transform=`translate(calc(-50% + ${n}px), calc(-50% + ${t}px))`}d.addEventListener("click",(i=>{i.stopPropagation(),o.classList.add("hidden"),chrome.runtime.sendMessage({action:"createPin",meetingId:n,pinData:{type:e}}).then((e=>{e?.success?p(`ピン「${t.label}」を作成しました`):(console.error("CS: Failed to create pin:",e?.error,"Code:",e?.code),p(`エラー: ピンを作成できませんでした (${e?.error||"不明なエラー"})`,!0))})).catch((e=>{h(e,"background","createPin"),p("エラー: ピンの作成依頼に失敗しました。",!0)}))})),o.appendChild(d)})),e.appendChild(o);const a=document.createElement("div");a.id="pins-area",e.appendChild(a),document.body?(document.body.appendChild(e),document.removeEventListener("click",l),document.addEventListener("click",l)):console.error("CS: setupUI: document.body not found.")}());const t=document.getElementById("ping-login-prompt");t&&t.remove()}else n&&!e?(r(),function(){if(document.getElementById("ping-login-prompt"))return;if(!window.location.href.includes("meet.google.com/"))return;if(!document.body)return;const e=document.createElement("div");e.id="ping-login-prompt",e.innerHTML='ピン機能を使うにはログインが必要です。<button id="ping-login-button">ログイン</button>',document.body.appendChild(e);const n=document.getElementById("ping-login-button");n?n.onclick=t=>{t.stopPropagation(),n.disabled=!0,n.textContent="処理中...",chrome.runtime.sendMessage({action:"requestLogin"}).then((t=>{t?.started?(p("ログインプロセスを開始しました..."),document.getElementById("ping-login-prompt")&&e.remove()):(p(`ログインを開始できませんでした (${t?.error||"不明なエラー"})`,!0),document.getElementById("ping-login-button")&&(n.disabled=!1,n.textContent="ログイン"))})).catch((e=>{h(e,"background","requestLogin"),p("ログイン開始に失敗しました。",!0),document.getElementById("ping-login-button")&&(n.disabled=!1,n.textContent="ログイン")}))}:console.error("CS: Could not find #ping-login-button in prompt.")}()):(r(),n=null)}function r(){document.removeEventListener("click",l);const e=document.getElementById("ping-container");e&&e.remove();const n=document.getElementById("ping-login-prompt");n&&n.remove();const o=document.getElementById("ping-message");o&&o.remove(),t={}}function l(e){const n=document.getElementById("ping-menu"),t=document.getElementById("ping-menu-button");n&&!n.classList.contains("hidden")&&(n.contains(e.target)||t&&t.contains(e.target)||n.classList.add("hidden"))}function m(e){e.stopPropagation();const n=document.getElementById("ping-menu");n&&n.classList.toggle("hidden")}function u(e,n=!0){const o=t[e],i=o?.element||document.getElementById(`pin-${e}`);if(i){const o=()=>{i.parentNode&&i.remove(),delete t[e]};n&&i.classList.contains("show")?(i.classList.remove("show"),i.classList.add("hide"),setTimeout(o,300)):o()}else delete t[e]}let g;function p(e,n=!1){let t=document.getElementById("ping-message");t||(t=function(){let e=document.getElementById("ping-message");return!e&&document.body&&(e=document.createElement("div"),e.id="ping-message",e.className="ping-message-area",document.body.appendChild(e)),e}()),t&&(g&&clearTimeout(g),t.textContent=e,t.className="ping-message-area",t.classList.add(n?"error":"success"),t.classList.add("show"),g=setTimeout((()=>{t.classList.remove("show")}),n?5e3:3e3))}function h(e,n,t="message"){e&&(["Receiving end does not exist","Extension context invalidated"].some((n=>e.message?.includes(n)))||console.warn(`CS: Error sending ${t} to ${n}: ${e.message||e}`))}chrome.runtime.onMessage.addListener(((c,s,r)=>{if(!chrome.runtime.lastError){switch(c.action){case"authStatusChanged":d(c),r({received:!0});break;case"pinAdded":n&&c.pinId&&c.pin&&function(o,c){const s=document.getElementById("pins-area");if(!s)return void console.warn("CS: #pins-area not found.");u(o,!1);const d=i[c.type]||{icon:chrome.runtime.getURL("icons/question.png"),label:"不明"},a=document.createElement("div");a.id=`pin-${o}`,a.className="pin";const r=e&&c.createdBy?.uid===e.uid;r&&a.classList.add("my-pin"),a.dataset.createdBy=c.createdBy?.uid||"unknown";const l=document.createElement("div");l.className="pin-icon";const m=document.createElement("img");m.src=d.icon,m.alt=d.label,m.width=24,m.height=24,l.appendChild(m),a.appendChild(l);const g=document.createElement("div");g.className="pin-details";const y=document.createElement("div");y.className="pin-label",y.textContent=d.label,g.appendChild(y);const E=document.createElement("div");E.className="pin-user",E.textContent=c.createdBy?.displayName||c.createdBy?.email?.split("@")[0]||"不明",g.appendChild(E),a.appendChild(g),r&&(a.title="クリックして削除",a.addEventListener("click",(()=>{a.classList.remove("show"),a.classList.add("hide"),chrome.runtime.sendMessage({action:"removePin",meetingId:n,pinId:o}).then((e=>{e?.success?setTimeout((()=>u(o,!1)),300):(console.error("CS: Failed to remove pin:",e?.error),p(`エラー: ピンを削除できませんでした (${e?.error||"不明なエラー"})`,!0),document.getElementById(`pin-${o}`)&&(a.classList.remove("hide"),a.classList.add("show")))})).catch((e=>{h(e,"background","removePin"),p("エラー: ピンの削除に失敗しました。",!0),document.getElementById(`pin-${o}`)&&(a.classList.remove("hide"),a.classList.add("show"))}))}))),r||function(){try{const e=chrome.runtime.getURL("sounds/pin_created.mp3"),n=new Audio(e);n.volume=.3,n.play().catch((e=>console.error("CS: Audio playback error:",e)))}catch(e){console.error("CS: Error in playSound function:",e)}}(),s.appendChild(a),requestAnimationFrame((()=>{a.classList.add("show")})),t[o]={element:a}}(c.pinId,c.pin),r({received:!0});break;case"pinRemoved":n&&c.pinId&&u(c.pinId),r({received:!0});break;case"dbPermissionError":p("エラー: DBアクセス権限がありません。",!0),r({received:!0});break;case"urlUpdated":c.url&&c.url!==o?(o=c.url,a(o)):c.url!==o||document.getElementById("ping-container")||a(o),r({received:!0});break;default:r({received:!1,message:"Unknown action"})}return!0}})),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s(),console.log("Meet Ping Extension content script loaded and initialized.")})();