(()=>{let e=null,n=null,t={},i=location.href;const o={question:{icon:chrome.runtime.getURL("icons/question.png"),label:"疑問"},onMyWay:{icon:chrome.runtime.getURL("icons/onMyWay.png"),label:"任せて"},danger:{icon:chrome.runtime.getURL("icons/danger.png"),label:"撤退"},assist:{icon:chrome.runtime.getURL("icons/assist.png"),label:"助けて"},goodJob:{icon:chrome.runtime.getURL("icons/goodJob.png"),label:"いい感じ"},finishHim:{icon:chrome.runtime.getURL("icons/finishHim.png"),label:"トドメだ"},needInfo:{icon:chrome.runtime.getURL("icons/needInfo.png"),label:"情報が必要"},changePlan:{icon:chrome.runtime.getURL("icons/changePlan.png"),label:"作戦変更"}},c={question:{angle:90,distance:70},onMyWay:{angle:45,distance:70},danger:{angle:0,distance:70},assist:{angle:-45,distance:70},goodJob:{angle:-90,distance:70},finishHim:{angle:-135,distance:70},needInfo:{angle:180,distance:70},changePlan:{angle:135,distance:70}};function s(){console.log("Content script: Initializing for URL:",i),chrome.runtime.sendMessage({action:"getAuthStatus"}).then(d).catch((e=>{h(e,"background","getAuthStatus"),d(null)})),a(i)}function d(n){const t=n?.user,o=e;e=t;const c=!!document.getElementById("ping-container");JSON.stringify(o)===JSON.stringify(e)&&c||a(i)}function a(t){const i=function(e){if(!e)return null;const n=e.match(/meet\.google\.com\/([a-z0-9\-]+)/i);return n?n[1]:null}(t);if(i!==n&&(n&&chrome.runtime.sendMessage({action:"stopListening",meetingId:n}).catch((e=>h(e,"background","stopListening"))),r(),n=i,n&&e&&chrome.runtime.sendMessage({action:"startListening",meetingId:n}).catch((e=>h(e,"background","startListening")))),n&&e){e&&n&&(document.getElementById("ping-container")||function(){if(document.getElementById("ping-container"))return;const e=document.createElement("div");e.id="ping-container";const t=document.createElement("button");t.id="ping-menu-button",t.innerHTML="<span>!</span>",t.title="ピンメニューを開く",t.addEventListener("click",m),e.appendChild(t);const i=document.createElement("div");i.id="ping-menu",i.classList.add("hidden");const s=document.createElement("div");s.id="ping-center";const d=document.createElement("img");d.src=chrome.runtime.getURL("icons/center-pin.png"),d.alt="PING",d.width=32,d.height=32,s.appendChild(d),i.appendChild(s),Object.keys(o).forEach((e=>{const t=o[e],s=c[e],d=document.createElement("div");d.className="ping-option",d.dataset.type=e,d.title=t.label;const a=document.createElement("div");a.className="ping-icon";const r=document.createElement("img");if(r.src=t.icon,r.alt=t.label,r.width=24,r.height=24,a.appendChild(r),d.appendChild(a),s){const e=s.angle*(Math.PI/180),n=s.distance||70,t=Math.cos(e)*n,i=Math.sin(e)*n;d.style.position="absolute",d.style.top="50%",d.style.left="50%",d.style.transform=`translate(calc(-50% + ${t}px), calc(-50% + ${i}px))`}d.addEventListener("click",(o=>{o.stopPropagation(),i.classList.add("hidden"),chrome.runtime.sendMessage({action:"createPin",meetingId:n,pinData:{type:e}}).then((e=>{e?.success?p(`ピン「${t.label}」を作成しました`):(console.error("CS: Failed to create pin:",e?.error,"Code:",e?.code),p(`エラー: ピンを作成できませんでした (${e?.error||"不明なエラー"})`,!0))})).catch((e=>{h(e,"background","createPin"),p("エラー: ピンの作成依頼に失敗しました。",!0)}))})),i.appendChild(d)})),e.appendChild(i);const a=document.createElement("div");a.id="pins-area",e.appendChild(a),document.body?(document.body.appendChild(e),document.removeEventListener("click",l),document.addEventListener("click",l)):console.error("CS: setupUI: document.body not found.")}());const t=document.getElementById("ping-login-prompt");t&&t.remove()}else n&&!e?(r(),function(){if(document.getElementById("ping-login-prompt"))return;if(!window.location.href.includes("meet.google.com/"))return;if(!document.body)return;const e=document.createElement("div");e.id="ping-login-prompt",e.innerHTML='ピン機能を使うにはログインが必要です。<button id="ping-login-button">ログイン</button>',document.body.appendChild(e);const n=document.getElementById("ping-login-button");n?n.onclick=t=>{t.stopPropagation(),n.disabled=!0,n.textContent="処理中...",chrome.runtime.sendMessage({action:"requestLogin"}).then((t=>{t?.started?(p("ログインプロセスを開始しました..."),document.getElementById("ping-login-prompt")&&e.remove()):(p(`ログインを開始できませんでした (${t?.error||"不明なエラー"})`,!0),document.getElementById("ping-login-button")&&(n.disabled=!1,n.textContent="ログイン"))})).catch((e=>{h(e,"background","requestLogin"),p("ログイン開始に失敗しました。",!0),document.getElementById("ping-login-button")&&(n.disabled=!1,n.textContent="ログイン")}))}:console.error("CS: Could not find #ping-login-button in prompt.")}()):(r(),n=null)}function r(){document.removeEventListener("click",l);const e=document.getElementById("ping-container");e&&e.remove();const n=document.getElementById("ping-login-prompt");n&&n.remove();const i=document.getElementById("ping-message");i&&i.remove(),t={}}function l(e){const n=document.getElementById("ping-menu"),t=document.getElementById("ping-menu-button");n&&!n.classList.contains("hidden")&&(n.contains(e.target)||t&&t.contains(e.target)||n.classList.add("hidden"))}function m(e){e.stopPropagation();const n=document.getElementById("ping-menu");n&&n.classList.toggle("hidden")}function u(e,n=!0){const i=t[e],o=i?.element||document.getElementById(`pin-${e}`);if(o){const i=()=>{o.parentNode&&o.remove(),delete t[e]};n&&o.classList.contains("show")?(o.classList.remove("show"),o.classList.add("hide"),setTimeout(i,300)):i()}else delete t[e]}let g;function p(e,n=!1){let t=document.getElementById("ping-message");t||(t=function(){let e=document.getElementById("ping-message");return!e&&document.body&&(e=document.createElement("div"),e.id="ping-message",e.className="ping-message-area",document.body.appendChild(e)),e}()),t&&(g&&clearTimeout(g),t.textContent=e,t.className="ping-message-area",t.classList.add(n?"error":"success"),t.classList.add("show"),g=setTimeout((()=>{t.classList.remove("show")}),n?5e3:3e3))}function h(e,n,t="message"){e&&(["Receiving end does not exist","Extension context invalidated"].some((n=>e.message?.includes(n)))||console.warn(`CS: Error sending ${t} to ${n}: ${e.message||e}`))}chrome.runtime.onMessage.addListener(((c,s,r)=>{if(!chrome.runtime.lastError){switch(c.action){case"authStatusChanged":d(c),r({received:!0});break;case"pinAdded":n&&c.pinId&&c.pin&&function(i,c){const s=document.getElementById("pins-area");if(!s)return;u(i,!1);const d=o[c.type]||{icon:chrome.runtime.getURL("icons/question.png"),label:"不明"},a=document.createElement("div");a.id=`pin-${i}`,a.className="pin";const r=e&&c.createdBy?.uid===e.uid;r&&a.classList.add("my-pin"),a.dataset.createdBy=c.createdBy?.uid||"unknown";const l=document.createElement("div");l.className="pin-icon";const m=document.createElement("img");m.src=d.icon,m.alt=d.label,m.width=24,m.height=24,l.appendChild(m),a.appendChild(l);const g=document.createElement("div");g.className="pin-details";const y=document.createElement("div");y.className="pin-label",y.textContent=d.label,g.appendChild(y);const b=document.createElement("div");b.className="pin-user",b.textContent=c.createdBy?.displayName||c.createdBy?.email?.split("@")[0]||"不明",g.appendChild(b),a.appendChild(g),r&&(a.title="クリックして削除",a.addEventListener("click",(()=>{a.classList.remove("show"),a.classList.add("hide"),chrome.runtime.sendMessage({action:"removePin",meetingId:n,pinId:i}).then((e=>{e?.success?setTimeout((()=>u(i,!1)),300):(console.error("CS: Failed to remove pin:",e?.error),p(`エラー: ピンを削除できませんでした (${e?.error||"不明なエラー"})`,!0),document.getElementById(`pin-${i}`)&&(a.classList.remove("hide"),a.classList.add("show")))})).catch((e=>{h(e,"background","removePin"),p("エラー: ピンの削除に失敗しました。",!0),document.getElementById(`pin-${i}`)&&(a.classList.remove("hide"),a.classList.add("show"))}))}))),r||function(){try{const e=chrome.runtime.getURL("sounds/pin_created.mp3"),n=new Audio(e);n.volume=.3,n.play().catch((e=>console.error("CS: Audio playback error:",e)))}catch(e){console.error("CS: Error in playSound function:",e)}}(),s.appendChild(a),requestAnimationFrame((()=>{a.classList.add("show")})),t[i]={element:a}}(c.pinId,c.pin),r({received:!0});break;case"pinRemoved":n&&c.pinId&&u(c.pinId),r({received:!0});break;case"dbPermissionError":p("エラー: DBアクセス権限がありません。",!0),r({received:!0});break;case"urlUpdated":c.url&&c.url!==i?(i=c.url,a(i)):c.url!==i||document.getElementById("ping-container")||a(i),r({received:!0});break;default:r({received:!1,message:"Unknown action"})}return!0}})),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s(),console.log("Meet Ping Extension content script loaded and initialized.")})();