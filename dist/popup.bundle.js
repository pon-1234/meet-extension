document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("status"),t=document.getElementById("user-info"),o=document.getElementById("user-email"),r=document.getElementById("login-section"),n=document.getElementById("login-button"),s=document.getElementById("logout-button"),i=document.getElementById("error-message");function u(e){i.textContent=e}function a(i){u(""),i?(e.textContent="ステータス: ログイン済み",o.textContent=i.displayName||i.email,r.style.display="none",t.style.display="block"):(e.textContent="ステータス: 未ログイン",r.style.display="block",t.style.display="none"),n.disabled=!1,n.textContent="Googleアカウントでログイン",s.disabled=!1,s.textContent="ログアウト"}n.addEventListener("click",(function(){n.disabled=!0,n.textContent="ログイン処理中...",u(""),chrome.runtime.sendMessage({action:"requestLogin"},(function(t){if(chrome.runtime.lastError)return console.error("Login request error:",chrome.runtime.lastError.message),u(`ログイン開始エラー: ${chrome.runtime.lastError.message}`),n.disabled=!1,void(n.textContent="Googleアカウントでログイン");t&&t.started?e.textContent="Googleアカウントを選択してください...":(u(t?.error||"ログインを開始できませんでした。"),n.disabled=!1,n.textContent="Googleアカウントでログイン")}))})),s.addEventListener("click",(function(){s.disabled=!0,s.textContent="ログアウト中...",chrome.runtime.sendMessage({action:"requestLogout"},(function(e){if(chrome.runtime.lastError)return console.error("Logout request error:",chrome.runtime.lastError.message),u(`ログアウトエラー: ${chrome.runtime.lastError.message}`),s.disabled=!1,void(s.textContent="ログアウト");e?.success?console.log("Logout successful via popup request."):(console.error("Logout request failed:",e?.error),u(`ログアウトエラー: ${e?.error||"不明なエラー"}`)),s.disabled=!1,s.textContent="ログアウト"}))})),e.textContent="ステータス: 認証状態を確認中...",chrome.runtime.sendMessage({action:"getAuthStatus"},(function(t){if(chrome.runtime.lastError)return console.error("Error getting auth status:",chrome.runtime.lastError.message),e.textContent="状態取得エラー",u(`状態取得エラー: ${chrome.runtime.lastError.message}`),void a(null);console.log("Initial auth status from background:",t?.user),a(t?.user)})),chrome.runtime.onMessage.addListener(((e,t,o)=>{if(!chrome.runtime.lastError)return"authStatusChanged"===e.action?(console.log("Popup received auth status update from background:",e.user),a(e.user),!0):void 0;console.warn("Popup onMessage listener error (likely context invalidated):",chrome.runtime.lastError.message)})),console.log("Popup script initialized.")}));