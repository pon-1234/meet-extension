document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("status"),t=document.getElementById("user-info"),n=document.getElementById("user-email"),o=document.getElementById("login-section"),s=document.getElementById("login-button"),d=document.getElementById("logout-button"),a=document.getElementById("error-message");function i(e){a.textContent=e}function u(a){i(""),a?(e.textContent="ステータス: ログイン済み",n.textContent=a.displayName||a.email,o.style.display="none",t.style.display="block"):(e.textContent="ステータス: 未ログイン",o.style.display="block",t.style.display="none"),s.disabled=!1,s.textContent="Googleアカウントでログイン",d.disabled=!1,d.textContent="ログアウト"}function r(e,t,n="message"){e&&(["Receiving end does not exist","Extension context invalidated"].some((t=>e.message?.includes(t)))||console.warn(`Popup: Error sending ${n} to ${t}: ${e.message||e}`))}s.addEventListener("click",(function(){s.disabled=!0,s.textContent="ログイン処理中...",i(""),chrome.runtime.sendMessage({action:"requestLogin"}).then((t=>{t&&t.started?e.textContent="Googleアカウントを選択してください...":(i(t?.error||"ログインを開始できませんでした。"),s.disabled=!1,s.textContent="Googleアカウントでログイン")})).catch((e=>{r(e,"background","requestLogin"),i(`ログイン開始エラー: ${e.message||"不明なエラー"}`),s.disabled=!1,s.textContent="Googleアカウントでログイン"}))})),d.addEventListener("click",(function(){d.disabled=!0,d.textContent="ログアウト中...",chrome.runtime.sendMessage({action:"requestLogout"}).then((e=>{e?.success?console.log("Logout successful via popup request."):(console.error("Logout request failed:",e?.error),i(`ログアウトエラー: ${e?.error||"不明なエラー"}`)),d.disabled=!1,d.textContent="ログアウト"})).catch((e=>{r(e,"background","requestLogout"),i(`ログアウトエラー: ${e.message||"不明なエラー"}`),d.disabled=!1,d.textContent="ログアウト"}))})),e.textContent="ステータス: 認証状態を確認中...",chrome.runtime.sendMessage({action:"getAuthStatus"}).then((e=>{u(e?.user)})).catch((t=>{r(t,"background","getAuthStatus"),e.textContent="状態取得エラー",i(`状態取得エラー: ${t.message||"不明なエラー"}`),u(null)})),chrome.runtime.onMessage.addListener(((e,t,n)=>{if(!chrome.runtime.lastError)return"authStatusChanged"===e.action?(u(e.user),!0):void 0}))}));